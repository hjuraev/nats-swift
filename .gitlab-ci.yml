stages:
  - build
  - test

variables:
  SWIFT_VERSION: "6.2"
  NATS_VERSION: "2.12"

# Base template for Swift jobs
.swift_base:
  image: swift:${SWIFT_VERSION}
  before_script:
    - swift --version
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .build/checkouts/
      - .build/repositories/

# Build job
build:
  extends: .swift_base
  stage: build
  script:
    - swift build -c release
  artifacts:
    paths:
      - .build/
    expire_in: 1 hour

# Test job with NATS server and TLS
test:
  extends: .swift_base
  stage: test
  variables:
    NATS_URL: "tls://localhost:4222"
  before_script:
    - swift --version
    - apt-get update && apt-get install -y openssl wget netcat-openbsd
    # Download and install NATS server
    - wget -q https://github.com/nats-io/nats-server/releases/download/v${NATS_VERSION}.0/nats-server-v${NATS_VERSION}.0-linux-amd64.tar.gz
    - tar -xzf nats-server-v${NATS_VERSION}.0-linux-amd64.tar.gz
    - mv nats-server-v${NATS_VERSION}.0-linux-amd64/nats-server /usr/local/bin/
    # Generate self-signed TLS certificates
    - mkdir -p ./certs
    - |
      openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout ./certs/server-key.pem \
        -out ./certs/server-cert.pem \
        -subj "/CN=localhost/O=NATS-Test/C=US" \
        -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
    # Start NATS server with TLS and JetStream
    - |
      nats-server \
        --tls \
        --tlscert=./certs/server-cert.pem \
        --tlskey=./certs/server-key.pem \
        --jetstream \
        --store_dir=/tmp/nats-jetstream \
        --port 4222 &
    # Wait for NATS to be ready
    - |
      for i in $(seq 1 30); do
        nc -z localhost 4222 && echo "NATS server ready" && break
        sleep 1
      done
    - sleep 2
  script:
    - swift test --parallel
  after_script:
    - pkill nats-server || true
